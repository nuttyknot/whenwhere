(function(){function a(){function b(a){return a.match(/^[0-9a-zA-Z]+$/)?!0:!1}function c(){backend.showLoading()}function d(){backend.hideLoading()}function e(a,b){var c="";b||(b=0);var d="";for(var f=0;f<b+1;f++)d+="    ";if(typeof a=="object")for(var g in a){var h=a[g];typeof h=="object"?(c+=d+"'"+g+"' ...\n",c+=e(h,b+1)):c+=d+"'"+g+"' => \""+h+'"\n'}else c="===>"+a+"<===("+typeof a+")";return c}function f(a){var b="http://www.gravatar.com/avatar/"+hex_md5(a)+".jpg?s=80";return b}function g(a){var b=a.getMinutes();return b/10<1&&(b="0"+b),a.getHours()+":"+b}function h(b,c,d){try{a||(a=new google.maps.Geocoder);var e=new google.maps.LatLng(b,c);a.geocode({latLng:e},function(a,b){if(b==google.maps.GeocoderStatus.OK){var c=a[1];c&&d(c.formatted_address)}else console.log("Geocoder failed due to: "+b)})}catch(f){}}function i(a){function b(a){return(""+a).length<2&&(a="0"+a),a}var c=new Date,e=c.getFullYear()+"-"+b(c.getMonth()+1)+"-"+b(c.getDate());n('_design/event/_view/by_creator?key=["'+a+'", "'+e+'"]',function(a){if(a.error){backend.showToast("Error:"+a.error);return}var b=a.rows,c=b.length,e=$("#event_container").empty();typeof c=="undefined"&&(b=[b],c=1);if(c==0)backend.showToast("No event yet!"),e.append('<li><a data-ajax="false" href="where.htm"><h3>No event yet!</h3><p>Create one?</p></a></li>');else for(var f=0;f<c;f++)e.prepend(k(b[f].value));e.listview("refresh"),d()})}function j(a){var b=$('<li><a class="person" data-email="'+a.email+'" href="#"><img alt="'+a.name+'" src="'+f(a.email)+'" /><h3>'+a.name+"<br/>"+a.email+"</h3><p>Within "+a.radius+' km. of <span class="position">'+a.position+"</span><br/>around "+a.when+"</p></a></li>");return h(a.latitude,a.longitude,function(a){$(".position",b).html(a)}),b}function k(a){var b=a.position,c=$('<li><a href="event_info.htm" data-event-id="'+a._id+'" class="event"><h3>'+a.action+"</h3><p>Within "+a.radius+' km. of <span class="position">'+a.position+"</span><br/>around "+a.when+"</p></a></li>");return h(a.latitude,a.longitude,function(a){$(".position",c).html(a)}),c}function l(a){var b=a.location,c=b.latitude,d=b.longitude,e=$('<li><a target="_blank" href="https://www.facebook.com/'+a.id+'" class="place"><img alt="'+a.name+'" src="https://graph.facebook.com/'+a.id+'/picture?type=square" /><h3>'+a.name+"</h3><p>"+a.category+'<br/><span class="position">'+c+","+d+'</span></p></a><a href="decide_when.htm" data-place-id="'+a.id+'" data-place-name="'+a.name+'" class="decide_when_link"></a></li>');return h(c,d,function(a){$(".position",e).html(a)}),e}function m(a,b,c){return $('<div class="disabled dual_slider ui-field-contain ui-body ui-br" data-role="fieldcontain"><label class="ui-input-text" for="start">'+a.name+': </label><input type="range" class="slider_start" value="'+(a.from-b)/6e4+'" min="0" step="30" max="'+c+'" /><input type="range" class="slider_end" value="'+(a.to-b)/6e4+'" min="0" step="30" max="'+c+'" data-theme="a" data-track-theme="b"/></div>')}function n(a,b){var c,d=backend.isInsideWebView();d?c="https://nuttyknot.cloudant.com/whenwhere/"+a:c="https://thedlyeationfiethaskedga:iuE0TjhIS682nccpdaORPJDv@nuttyknot.cloudant.com/whenwhere/"+a,$.ajax({url:c,success:b,beforeSend:function(a){a.setRequestHeader("Authorization","Basic aW5raW5naW11bGRzdGlmZmljYXRhaWxsOjdud2FqRGZwVUw3UU1mRklKeUFIZUJvTg==")},error:function(a,b,c){console.log("ERROR:"+a+b+c)},dataType:d?"json":"jsonp"})}function o(a){function e(){c--,c==0&&d()}if(!b(a))return;var c=2;n('_design/rsvp/_view/by_event_id?key="'+a+'"',function(b){if(b.error){backend.showToast("Error:"+b.error);return}localStorage[a]=JSON.stringify(b);var c=b.rows,d=c.length,f=$("#people_container").empty(),g=0,h=0;typeof d=="undefined"&&(c=[c],d=1);for(var i=0;i<d;i++){var k=c[i].value;g+=k.latitude,h+=k.longitude,f.prepend(j(k))}localStorage.mean_pos=g/d+","+h/d,f.listview("refresh"),e()}),n('_design/decision/_view/by_event_id?key="'+a+'"',function(a){if(a.error){backend.showToast("Error:"+a.error);return}var b=a.rows,c=b.length,d=$(".decision");typeof c=="undefined"&&(b=[b],c=1);if(c!=0){b=b[0].value,d.html("<h3>Let's meet!</h3>When: <strong>"+b.when+"</strong><br/>Where: <strong><span class='"+b.place_id+" place'><a href='https://www.facebook.com/"+b.place_id+"'>"+b.place_id+"</a></span></strong><br/>"),$("#event_info .owner").css("opacity",0);var f={};backend.isInsideWebView()&&(f=JSON.stringify(f)),backend.queryGraph(b.place_id,f)}e()})}function p(a){var b={type:"place",center:a,distance:"10000"},d=localStorage.place_query;d&&(b.q=d),backend.isInsideWebView()&&(b=JSON.stringify(b)),c(),backend.queryGraph("search",b)}function q(a){var b=a.rows,c=b.length,e=$("#when_list").empty(),f,g,h,i,j;typeof c=="undefined"&&(b=[b],c=1);for(var k=0;k<c;k++){var l=b[k].value,n=l.when.match(/[0-9]+\:[0-9]+/g);l.from=h=Date.parse(n[0]),l.to=i=Date.parse(n[1]),h>i&&(l.to=i.add(1).days()),k==0?(f=h,g=i):(h<f&&(f=h),i>g&&(g=i))}j=(g-f)/6e4;for(var k=0;k<c;k++){var l=b[k].value,o=m(l,f,j);o.prependTo(e).trigger("create")}return d(),{min_when:f,max:j}}function r(a){var b=a.data,c=b.length,e=$("#places_container").empty();if(c==0)backend.showToast("No place found!"),e.append("<li><h3>No place found!</h3></li>");else for(var f=0;f<c;f++)e.append(l(b[f]));e.listview("refresh"),d()}var a;this.facebook_callback=function(a){var b;typeof a!="object"?b=JSON.parse(a):b=a;switch($.mobile.activePage.attr("id")){case"when":$("#when #name").val(b.name),$("#when #email").val(b.email),d();break;case"event_info":$(".place."+b.id).html(b.name);break;case"my_event":i(b.email);break;case"decide_where":r(b)}},$(function(){function a(a){var e=$("#"+a);switch(a){case"search":delete localStorage.event_id,delete localStorage.isOwner;var f=$("form",e),h=$("#event_number"),i=window.location.hash;f.submit(function(){var a=h.val();if(a==""||!b(a))return h.focus(),!1;localStorage.event_id=a}),backend.isInsideWebView()?$("#qr_code",e).click(function(){backend.scanQR()}):$("#qr_code",e).hide(),i&&(h.val(i.match(/#event_id=([A-Za-z0-9]+)/)[1]),f.submit());break;case"event_info":var j=localStorage.event_id,k=localStorage.isOwner,l=backend.isInsideWebView();if(!j){backend.showToast("No event_id!"),$.mobile.changePage("main.htm");return}$(".join button",e).click(function(){localStorage.isJoin=!0,backend.createWhere(j)}),$(".owner a",e).attr("href","decide_where.htm#"+j).click(function(){localStorage.event_id=j,localStorage.isOwner=k;if(!l)return $.mobile.changePage("decide_where.htm"),!1}),l?k&&($(".owner",e).show(),$(".join",e).hide()):($(".owner",e).hide(),$(".join",e).hide()),o(j);break;case"when":var m=$(".slider_start",e),n=$(".slider_end",e),r=Math.ceil((new Date).getTime()/18e5)*18e5,s=new Date(r+18e5),t=new Date(r+54e5),u=t-s,v=$("#free_time",e),w=$("#name",e).val(localStorage.name),x=$("#email",e).val(localStorage.email),y=1*m.val(),z=1*n.val();function A(){var a=u/36e5;v.val(g(s)+" - "+g(t)+" (About "+a+" "+(a>1?"hours":"hour")+")"),u=t-s}A(),m.change(function(){y=1*m.val(),s=new Date(r+y*6e4),A(),y>z&&n.val(y).slider("refresh")}),n.change(function(){z=1*n.val(),t=new Date(r+z*6e4),A(),y>z&&m.val(z).slider("refresh")}),$("#connect_facebook",e).click(function(){c(),backend.facebookSSO()}),$("form",e).submit(function(){var a=w.val(),b=localStorage.event_id,d=x.val(),e=$("#action"),f=e.val();return a==""?(backend.showToast("Please enter name"),w.focus(),!1):d==""?(backend.showToast("Please enter email"),x.focus(),!1):f==""?(backend.showToast("Please enter action"),e.focus(),!1):1*m.val()>=1*n.val()?(backend.showToast("End time must be later than Start time"),!1):(c(),localStorage.isJoin||(b=""),localStorage.name=a,localStorage.email=d,localStorage.action=f,$('button[type="submit"]',this).attr("disabled","disabled"),backend.submit(a,d,f,v.val(),b),!1)});break;case"result":var j=localStorage.event_id;if(!j){backend.showToast("No event_id!"),$.mobile.changePage("main.htm");return}var B="https%3A%2F%2Fdl.dropbox.com%2Fu%2F1629873%2Fwhenwhere%2Fwww%2Fsearch.htm%23event_id%3D",C="http://chart.apis.google.com/chart?chs=200x200&cht=qr&chl="+B+j,D=$("<img/>").attr({alt:"qr code",id:"qr_code",src:C});$("#img_container",e).append(D),$(".share",e).click(function(){return backend.shareLink("Let's "+localStorage.action+"! https://dl.dropbox.com/u/1629873/whenwhere/www/search.htm#event_id="+j+" "+C),!1}),d();break;case"my_event":c(),delete localStorage.event_id,delete localStorage.isOwner,backend.facebookSSO();break;case"decide_where":var E=localStorage.mean_pos;if(!E){$.mobile.changePage("my_event.htm");return}p(E);break;case"search_where":var F=$("#place_query",e);F.val(localStorage.place_query),$("form",e).submit(function(){return localStorage.place_query=F.val(),$(".ui-dialog").dialog("close"),!1});break;case"decide_when":var G=localStorage.event_id,H=localStorage[G];if(!G||!H){$.mobile.changePage("my_event.htm");return}var I=q(JSON.parse(H)),r=I.min_when,J=I.max,m=$(".input .slider_start",e).attr("max",J).slider("refresh"),n=$(".input .slider_end",e).attr({value:J,max:J}).slider("refresh"),s=r,t=new Date(r.getTime()+J*6e4),u=t-s,v=$("#free_time",e),y=1*m.val(),z=1*n.val();function A(){var a=u/36e5;v.val(g(s)+" - "+g(t)+" (About "+a+" "+(a>1?"hours":"hour")+")"),u=t-s}A(),m.change(function(){y=1*m.val(),s=new Date(r.getTime()+y*6e4),A(),y>z&&n.val(y).slider("refresh")}),n.change(function(){z=1*n.val(),t=new Date(r.getTime()+z*6e4),A(),y>z&&m.val(z).slider("refresh")}),$("form",e).submit(function(){return 1*m.val()>=1*n.val()?(backend.showToast("End time must be later than Start time"),!1):(c(),$('button[type="submit"]',this).attr("disabled","disabled"),backend.decide(localStorage.event_id,localStorage.place_id,localStorage.place_name,v.val()),delete localStorage.place_id,!1)})}}delete localStorage.isJoin,delete localStorage.mean_pos,delete localStorage.place_query,$(".event").live("click",function(){c(),localStorage.event_id=$(this).data("event-id"),localStorage.isOwner=!0}),$(".person").live("click",function(){return backend.showContact($(this).data("email")),!1}),$(".decide_when_link").live("click",function(){localStorage.place_id=$(this).data("place-id"),localStorage.place_name=$(this).data("place-name")}),$(document).bind("pagechange",function(b,c){a(c.toPage.attr("id"))}),a($.mobile.activePage.attr("id"))})}if(window.whenwhere)return;a.prototype={createWhere:function(){backend.createWhere()},callback:function(a){switch($.mobile.activePage.attr("id")){case"search":$("#event_number").val(a),$("#search form").submit();break;case"when":localStorage.isJoin?(console.log("Join!"+localStorage.event_id),delete localStorage.isJoin):(localStorage.event_id=a,console.log("Done!"+a)),$.mobile.changePage("result.htm");break;case"decide_when":backend.showToast("Done!"),$.mobile.changePage("event_info.htm")}},facebook_login_callback:function(){backend.queryGraph("me")}},window.whenwhere||(window.whenwhere=new a)})()